# Prompts used to create this application

This application was built using Claude Code (version 2.1.59 with the Sonnet 4.6 model) just from the [InitialRequirements.md](./InitialRequirements.md) file and the following prompts.  Note that Claude was left to request permission for each action, and on a couple of occasions it's suggested action was interrupted to provide a better alternative.

This information is probably not useful for an AI coding agent to continue with the development of the application.  But it might be interesting for humans to see how the development has progressed.

I haven't hand-edited any of the code or project files, etc.  The only changes I have made myself are:
- Some of the documentation Markdown files (including this document, the [README.md](../README.md) and information on how to use the proxy, etc), but not any of the planning or implementation history documents.
- Files inside the [.devcontainer](../.devcontainer) and [.vscode](../.vscode) directories (through VS Code)
- The [.gitignore](../.gitignore) file was also generated by me by running the `dotnet new gitignore` CLI command.
- The [LICENCE](../LICENCE) file

## Prompts

### Initial planning
```
There is an "InitialRequirements.md" file in the docs directory.  Can you examine the "Initial Requirements for Version 1"
section and plan out a detailed set of tasks to complete to meet these objectives.  Can you then write these tasks out
into the file "ImplementationPlan-v1.md" in the docs directory
```

Claude then created the [ImplementationPlan-v1.md](./plans/ImplementationPlan-v1.md) document.  This was checked and seemed
reasonable, although Claude had originally suggested implementing the project with .Net 8 or .Net 9.  I didn't change this
by hand, but instead asked Claude to do it.

```
Can you update the plan in phase 1 to use .Net 10
```

Claude then made the appropriate change to the plan.

### Phase 1

```
ok thanks - can you now implement phase 1 of the plan.  Don't move on to any further phases at the moment - just phase 1
and then stop
```

At one point during it's implementation Claude was searching for a `.sln` file, but it had previously created the solution
file as a `.slnx` file, so I interjected:

```
you are searching for a .sln file - but you should be searching for a .slnx file - try that
```

It then found the file and continued until it had completed phase 1.

```
Can you adjust the implementationplan-v1 doc and the Claude.md file to say that when unit tests will be added, they will
be done using nunit
```

It did so, but didn't have to change any code as it hadn't written any tests yet.

```
Can you write down all of the steps you have followed so far into the file docs/Phase1Steps.md
```

It created the [Phase1Steps.md](./plans/Phase1Steps.md) file - documenting the steps it had taken so far, based on the
conversation history.

### Phase 2

```
Can you now implement phase 2 of the plan.  Again, don't move on to any further phases at the moment - just phase 2 and
then stop.  Once you have completed phase 2 can you write down a file in the docs dir called Phase2Steps.md with all of
the steps you have followed to implement phase 2.
```

It created the reverse proxy middleware and wired it into the project, and wrote [Phase2Steps.md](./plans/Phase2Steps.md).

```
Can you add a step to the end of phase 2 of the plan to add unit testing to the ProxyMiddleware to check that it correctly
forwards on requests and handles the responses.  The RichardSzalay.MockHttp library might be useful for this, but if you
think there is a better alternative then fine.  Then once you have completed this extra work can you write down a file in
the docs dir called Phase2ExtraSteps.md with all of the steps you have followed to implement this.
```

It created the tests using the suggested library and wrote [Phase2ExtraSteps.md](./plans/Phase2ExtraSteps.md).

Claude's context was getting full (to 78%) so I created a new conversation and continued with the following.

### Phase 3

```
You are running through the implementation plan in docs/ImplementationPlan-v1.md.  You've already completed Phase 1 and
Phase 2.  Can you now implement phase 3 of the plan.  Don't move on to any further phases at the moment - just phase 3
and then stop.  Once you have completed phase 3 can you write down a file in the docs dir called Phase3Steps.md with all
of the steps you have followed to implement phase 3.
```

At one point during it's implementation Claude was suggesting injecting a real version of the RecordingService to the
middleware to get the existing tests to pass.  I stopped it and made a different suggestion:

```
Can you think about this again please - I think you should use the Moq library and add a Mock version of the recording
service here.  Then the mock can be asserted that it was called without needing to be a real service making real changes
to a database. 
```

It created the database recording mechanism and wired it into the reverse proxy middleware, fixed  the tests and added
some new ones and wrote [Phase3Steps.md](./plans/Phase3Steps.md).

I then manually performed a code review and raised some points to address in [CodeReviewsAfterPhase3.md](./plans/CodeReviewsAfterPhase3.md).

```
You are running through the implementation plan in docs/ImplementationPlan-v1.md.  You've already completed Phase 1,
Phase 2 and phase 3.  There has now been a code review after Phase 3 and the code review comments have been made in
/docs/CodeReviewsAfterPhase3.md.  Can you action the next review comment that hasn't already been addressed (i.e. without
a cross next to it).  Then when you are finished modify the code review doc so there is a cross next to the point you have
completed.  Then stop - ONLY DO ONE CODE REVIEW POINT.  If there is any uncertainty as what to do then feel free to ask,
otherwise crack on.
```

It addressed the first point (breaks up middleware into smaller methods)

```
Can you action the next review comment that hasn't already been addressed (i.e. without a cross next to it).  Then when
you are finished modify the code review doc so there is a cross next to the point you have completed.  Then stop -
ONLY DO ONE CODE REVIEW POINT.  If there is any uncertainty as what to do then feel free to ask, otherwise crack on.
```

It addressed the second point (implement repository pattern).  I then ran exactly the same prompt 2 more times to address
the third (add tests to the recording service) and fourth points (moved the docs).  I decided it should also move one
more document so said:

```
Can you also move the code review doc your working on into the plans directory too
```

And it did so.  I then continued with the same "Action the code review" prompt and it did the fifth point (move code
into src and dest folders).  Claude's context was getting full again (to 62%) so I created a new conversation and continued
with the following to address the final code review point (create end to end tests)

```
You are running through the implementation plan in docs/plans/ImplementationPlan-v1.md.  You've already completed Phase 1,
Phase 2 and phase 3.  There has now been a code review after Phase 3 and the code review comments have been made in
/docs/CodeReviewsAfterPhase3.md.  Can you action the next review comment that hasn't already been addressed (i.e. without
a cross next to it).  Then when you are finished modify the code review doc so there is a cross next to the point you have
completed.  Then stop - ONLY DO ONE CODE REVIEW POINT.  If there is any uncertainty as what to do then feel free to ask,
otherwise crack on.
```

It seemed to get a bit stuck with the tests failing.  Perhaps I got a bit impatient, but I interrupted the agent and said:

```
I've interrupted you to try and help - it looks like the tests aren't passing.  I think you need to update the upstreamOptions
service inside builder.ConfigureTestServices() to be bound to the new configuration which has the dummy Upstream:BaseUrl set
up.  Give that a try
```

After a while it sorted it out and the tests passed.

```
Can you write down all of the steps you have followed so far and append them to the existing file docs/plans/Phase3PostCodeReviewSteps.md
```

The document was updated - the code review has been completed.

### Phase 4

```
You are running through the implementation plan in docs/plans/ImplementationPlan-v1.md.  You've already completed Phase 1,
Phase 2 and Phase 3.  Please now continue with phase 4 and don't move on to any further phases at the moment - just phase 4
and then stop.  Once you have completed phase 4 can you write down a file in the docs dir called Phase4Steps.md with all of
the steps you have followed to implement phase 4.

To help with implementing phase 4 I have included a sample request and results file for a call to the `/v1/messages` endpoint.
These can be found in docs/sample-data.  Note the sample result is of content type `text\event-stream` so is a set of JSON
responses, not just a single JSON object.

If there is any uncertainty as what to do then feel free to ask, otherwise crack on.
```

It created the token parser and updated services and tests as required, although the prompt accidentally asked for the Phase4Steps.md to be put in the wrong directory.  And the RecordingServiceTest file also now stood out as being in the wrong directory.

```
could you move the phase4steps.md to the docs/plans dir
```

```
could you move the RecordingServiceTests into the Services subdir too
```

It did both these things (adjusting references where required).  Running the proxy to manually test it, I found that the token recording wasn't working properly, with no data in the database.

```
can you add tests to the recording service to ensure that LLM usage data is also correctly recorded and saved
```

```
Can you also add tests to the Recording repository - just a small number to check that proxy requests and llm usage results can be saved correctly
```

As requested, this only changed the tests, so the token usage still wasn't being recorded.  I investigated manually and found that the results from the proxy were being returned gzipped in most cases.

```
I have manually tested this code and it appears that the proxied responses can have a content encoding of gzip.  Can
you Write a test for the proxy middleware that has an example of a gzipped response and then adjust the middleware so 
it passes an unzipped version of the response to the recording service.
```

It wrote the failing test and then adjusted the code to match.  Then retesting this manually showed the results were now recorded correctly.

```
Can you write down a file in the docs/plans dir called Phase4AfterTestingSteps.md with all of the steps you have
followed to fix the issue above.
```

### Phase 5

I started a new context:

```
You are running through the implementation plan in docs/plans/ImplementationPlan-v1.md.  You've already completed
Phases 1, 2, 3 and 4.  Can you adjust the implementation plan and remove step 5.3, as previously in the code
reviews after phase 3 we said we didn't want to use the ANTHROPIC_BASE_URL environment variable to configure the
proxy.  Then can you continue with phase 5 and don't move on to any further phases at the moment - just phase 5
and then stop.  Once you have completed phase 5 can you write down a file in the docs/plans dir called Phase5Steps.md
with all of the steps you have followed to implement phase 5.
```

Did this work, but then this meant the tests produced a lot more logging

```
When running the tests, can you stop the logging output to the console
```

```
Can you also add a new End to End test to cover resposnes having a gzip content encoding
```

```
Can you write up the last 2 steps into a Phase5ExtraSteps.md file
```

### Phase 6

I started a new context:

```
You are running through the implementation plan in docs/plans/ImplementationPlan-v1.md.  You've already
completed Phases 1 to 5.  Can you continue with phase 6 and don't move on to any further phases at the
moment - just phase 6 and then stop.  Once you have completed phase 6 can you write down a file in the
docs/plans dir called Phase6Steps.md with all of the steps you have followed to implement phase 6.
```

It did all of this, but hadn't been using the repository pattern:

```
Can you adjust the stats service to use the RecordingRepository rather than the ProxyDbContext directly.
Then you can add what you had to do to a new Phase5ExtraSteps doc
```

It then completed this work.

### Phase 7

```
You are running through the implementation plan in docs/plans/ImplementationPlan-v1.md.  You've already
completed Phases 1 to 6.  This implementation plan was based on the docs/InitialRequirements.md, but I
have changed the last requirement so that the plan for phase 7 should be changed to implement a Angular
SPA app to visualise the results held in the database.  Can you update the phase 7 part of the plan to
reflect this.
```

It updated the plan

```
Now can you run through phase 7 of the plan and then stop.  Once you have completed phase 7 can you write
down a file in the docs/plans dir called Phase7Steps.md with all of the steps you have followed to
implement phase 7.
```

Then as it was processing through this it was going to install the Angular CLI globally, but I wanted this to be installed just locally, so I interjected:

```
Rather than installing the Angular CLI globally, can you install it just for this project, please
```

The innitial version of the Angular app was then created.

```
Shouldn't the contents of src/ClaudeCodeProxy/wwwroot that are built up as part of the angular build be git
ignored as we don't want these to be accidentally committed into the repo?
```

This is actioned.  However, when testing this manually I noticed this didn't work properly through the VS Code devcontainers, but this could be fixed by changing the host from `localhost` to `127.0.0.1`:

```
Can you change the npm start command to specify the host 127.0.01 - as this makes it easy to run via
devcontainers in VSCode
```

Then as this is being actioned, the CORS settings in the API is being changed incorrectly, so I interject:

```
The origin can be localhost or 127.0..01 for CORS here - include both
```

This is then fixed, but then the Angular app can't connect to the API.  Perhaps the port is wrong:

```
Also - the app doesn't appear to be working as I think the app assumes the API is running on port 5000
when it looks like it is running on port 5051 - can you check this?
```

This is fixed and the app now works.

```
Can you write up all the steps after the inital phase 7 implementation into a Phase7ExtraSteps.md file
```

This is also done.